services:
  frigate:
    container_name: frigate
    image: ghcr.io/blakeblackshear/frigate:stable
    privileged: true
    restart: unless-stopped
    shm_size: '1gb'
    devices:
      - /dev/dri:/dev/dri     # Intel iGPU / NPU access
    environment:
      - TZ=America/Los_Angeles
      - LIBVA_DRIVER_NAME=iHD # Intel VAAPI driver (required)
      - QSV_HEVC=1            # Optional: enable QuickSync HEVC decode if needed
      - FRIGATE_MQTT_PASSWORD=${FRIGATE_MQTT_PASSWORD}
      # Camera credentials
      - FRIGATE_CAM_USER=${FRIGATE_CAM_USER}
      - FRIGATE_INDOOR_CAM_01_IP=${FRIGATE_INDOOR_CAM_01_IP}
      - FRIGATE_INDOOR_CAM_01_PASSWORD=${FRIGATE_INDOOR_CAM_01_PASSWORD}
      - FRIGATE_INDOOR_CAM_02_IP=${FRIGATE_INDOOR_CAM_02_IP}
      - FRIGATE_INDOOR_CAM_02_PASSWORD=${FRIGATE_INDOOR_CAM_02_PASSWORD}
      - FRIGATE_INDOOR_CAM_03_IP=${FRIGATE_INDOOR_CAM_03_IP}
      - FRIGATE_INDOOR_CAM_03_PASSWORD=${FRIGATE_INDOOR_CAM_03_PASSWORD}
      - FRIGATE_INDOOR_CAM_04_IP=${FRIGATE_INDOOR_CAM_04_IP}
      - FRIGATE_INDOOR_CAM_04_PASSWORD=${FRIGATE_INDOOR_CAM_04_PASSWORD}
      - FRIGATE_OUTDOOR_CAM_01_IP=${FRIGATE_OUTDOOR_CAM_01_IP}
      - FRIGATE_OUTDOOR_CAM_01_PASSWORD=${FRIGATE_OUTDOOR_CAM_01_PASSWORD}
      - FRIGATE_OUTDOOR_CAM_02_IP=${FRIGATE_OUTDOOR_CAM_02_IP}
      - FRIGATE_OUTDOOR_CAM_02_PASSWORD=${FRIGATE_OUTDOOR_CAM_02_PASSWORD}
    ports:
      - "1935:1935"  # RTMP
      - "8971:8971"  # Authenticated UI
      # - "5000:5000"  # Unauthenticated internal API
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./frigate.yml.base:/config/config.yml.base:ro
      - ./entrypoint.sh:/entrypoint.sh:ro
      - ./config:/config
      - /srv/media/frigate:/media/frigate
      - type: tmpfs  # Cache in RAM to reduce disk wear
        target: /tmp/cache
        tmpfs:
          size: 1073741824  # 1GiB
    entrypoint: /entrypoint.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  mqtt:
    container_name: mqtt
    image: docker.io/eclipse-mosquitto:2.0
    restart: unless-stopped
    ports:
      - "1883:1883"   # Standard MQTT port
      # - "9001:9001"   # Websocket port
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
      # - ./secrets/mosquitto_passwd:/mosquitto/config/mosquitto_passwd
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "1883"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  frigate-manager:
    container_name: frigate-manager
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      frigate:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    environment:
      - TZ=America/Los_Angeles
      - FRIGATE_AUTH_PASSWORD=${FRIGATE_AUTH_PASSWORD}
      - FRIGATE_MQTT_PASSWORD=${FRIGATE_MQTT_PASSWORD}
    volumes:
      # Mount source files as volumes for easy development
      - ./frigate_manager.py:/app/frigate_manager.py:ro
      - ./frigate_mqtt_client.py:/app/frigate_mqtt_client.py:ro
      - ./frigate-mgr.yml:/etc/frigate-mgr.yml:ro

