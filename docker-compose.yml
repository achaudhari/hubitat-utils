services:
  # Caddy - Authentication proxy
  caddy:
    image: caddy:alpine
    container_name: caddy
    restart: unless-stopped
    volumes:
      - ./config/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    extra_hosts:
      - "hubitat:192.168.1.192"

  # Cloudflared - Web access
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --loglevel info --no-autoupdate run --token ${TOKEN_HLAB_HAUTO_HELIOLOGIC_XYZ}
    environment:
      - TOKEN_HLAB_HAUTO_HELIOLOGIC_XYZ=${TOKEN_HLAB_HAUTO_HELIOLOGIC_XYZ}
    volumes:
      - ./cloudflared:/etc/cloudflared
    extra_hosts:
      - "hubitat:192.168.1.192"

  # InfluxDB - Time-series database for sensor data
  influxdb:
    image: docker.io/library/influxdb:1.8
    container_name: influxdb
    hostname: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"  # HTTP API
      - "8088:8088"  # RPC service (backup/restore)
    volumes:
      # Persistent data storage
      - ./influxdb/data:/var/lib/influxdb:rw
      # Configuration file
      - ./influxdb/config:/etc/influxdb:ro
    environment:
      - INFLUXDB_DB=Hubitat
      - INFLUXDB_HTTP_AUTH_ENABLED=false
      # - INFLUXDB_ADMIN_USER=${INFLUXDB_ADMIN_USER}
      # - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - INFLUXDB_USER=${INFLUXDB_USER}
      - INFLUXDB_USER_PASSWORD=${INFLUXDB_PASSWORD}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Grafana - Visualization and dashboards
  grafana:
    image: docker.io/grafana/grafana:latest
    container_name: grafana
    hostname: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"  # Web interface
    volumes:
      # Persistent data (dashboards, users, etc.)
      - ./grafana:/var/lib/grafana:rw
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - influxdb
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Hubitat Offload Daemon - RPC Server for home automation operations
  hubitat-offload:
    build:
      context: offload-proc
      dockerfile: Dockerfile
    container_name: hubitat-offload
    hostname: hubitat-offload
    restart: unless-stopped
    # Note: Removed network_mode: host for Podman Compose compatibility
    # Using bridge network with explicit port mapping instead
    ports:
      - "4226:4226"  # RPC Server
    volumes:
      - ./offload-proc:/opt/hauto/offload-proc:ro
      - ./roomba:/opt/hauto/roomba:ro
      - ./config:/etc/hauto:ro
      - ./config/msmtprc:/etc/msmtprc:ro
      - ./cache:/var/hauto:rw
    environment:
      - TZ=America/Los_Angeles
      - PYTHONUNBUFFERED=1
      - SERVICE_NAME=offload
      - HUBITAT_SECRET=${HUBITAT_SECRET}
      - ETH_IFACE_MAC=${ETH_IFACE_MAC}
      - INFLUXDB_HOST=influxdb
      - INFLUXDB_PORT=8086
      - INFLUXDB_USER=${INFLUXDB_USER}
      - INFLUXDB_PASSWORD=${INFLUXDB_PASSWORD}
      # Offload daemon configuration
      - RPC_ADDR=0.0.0.0
      - RPC_PORT=4226
      - PROCESSES=3
      # SMTP configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_USE_STARTTLS=${SMTP_USE_STARTTLS}
      - SMTP_FROM_DOMAIN=${SMTP_FROM_DOMAIN}
    cap_add:
      - NET_ADMIN      # Network administration
      - NET_RAW        # Raw network packet access
      - SYS_PTRACE     # Process monitoring
    dns:
      - 192.168.1.1
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "sh", "-c", "python3 -c \"import requests; requests.post('http://localhost:4226', json={'jsonrpc': '2.0', 'method': 'echo', 'params': ['health'], 'id': 1})\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      - influxdb

  # Hubitat Event Daemon - Monitors and acts on state changes
  hubitat-event:
    build:
      context: offload-proc
      dockerfile: Dockerfile
    container_name: hubitat-event
    hostname: hubitat-event
    restart: unless-stopped
    # Note: Removed network_mode: host for Podman Compose compatibility
    # ICMP ping and network monitoring will work via bridge network with elevated caps
    volumes:
      - ./offload-proc:/opt/hauto/offload-proc:ro
      - ./config:/etc/hauto:ro
      - ./config/msmtprc:/etc/msmtprc:ro
      - ./cache:/var/hauto:rw
      - ./ssh:/home/admin/.ssh:ro
    environment:
      - TZ=America/Los_Angeles
      - PYTHONUNBUFFERED=1
      - SERVICE_NAME=event
      - INFLUXDB_HOST=influxdb
      - INFLUXDB_PORT=8086
      - INFLUXDB_USER=${INFLUXDB_USER}
      - INFLUXDB_PASSWORD=${INFLUXDB_PASSWORD}
      # Event daemon configuration
      - POLL_INTERVAL=${POLL_INTERVAL:-5.0}
      # SMTP configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_USE_STARTTLS=${SMTP_USE_STARTTLS}
      - SMTP_FROM_DOMAIN=${SMTP_FROM_DOMAIN}
    # userns_mode: "host" # Run in the host user namespace and access docker socket
    cap_add:
      - NET_ADMIN      # Network monitoring
      - NET_RAW        # ICMP ping operations
      - NET_BROADCAST  # ARP operations
      - SYS_PTRACE     # Process monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "hubitat-event-daemon.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    # Start after offload daemon and influxdb
    depends_on:
      - influxdb

  # # Roomba980-Python - Roomba vacuum control interface
  # roomba-python:
  #   build:
  #     context: offload-proc
  #     dockerfile: Dockerfile
  #   container_name: roomba-python
  #   hostname: roomba-python
  #   restart: unless-stopped
  #   volumes:
  #     - ./roomba:/opt/hauto/roomba:rw
  #     - ./config:/etc/hauto:ro
  #     - ./cache/roomba:/var/roomba:rw
  #   environment:
  #     - TZ=America/Los_Angeles
  #     - PYTHONUNBUFFERED=1
  #     - SERVICE_NAME=roomba
  #     # Web server port
  #     - WEBPORT=8200
  #     - OPENSSL_CONF=/etc/hauto/roomba-ssl.conf
  #     # Map configuration
  #     - ENABLE_MAPS=false
  #     - MAP_PATH=/var/roomba/maps
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8200/api/local/info/state"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s

volumes:
  caddy_data:
  caddy_config:
